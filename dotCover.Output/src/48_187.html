<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\CleanArchitecture\API\Program.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Application;
using Infrastructure;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Identity;
using Microsoft.IdentityModel.Tokens;
using Microsoft.OpenApi.Any;
using Microsoft.OpenApi.Models;
using Serilog;
using Swashbuckle.AspNetCore.SwaggerGen;
using System.Diagnostics.CodeAnalysis;
using System.Text;
using System.Text.Json.Serialization;
namespace API;

[ExcludeFromCodeCoverage]
public static class Program
{
    private static async Task Main(string[] args)
    {
        var builder = WebApplication.CreateBuilder(args);

        // Add services to the container.
        builder.Services.
            AddControllers()
            .AddJsonOptions(options =&gt; options.JsonSerializerOptions.Converters.Add(new JsonStringEnumConverter()));

        builder.Services
            .AddApplication(builder.Configuration)
            .AddInfrastructure(builder.Configuration);

        builder.Host.UseSerilog((context, configuration) =&gt; configuration.ReadFrom.Configuration(context.Configuration));

        var jwtKey = builder.Configuration[&quot;Jwt:Key&quot;];
        if (jwtKey != null)
        {
            builder.Services.AddAuthentication(options =&gt;
            {
                options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
                options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
            })
            .AddJwtBearer(&quot;Bearer&quot;, options =&gt;
            {
                options.TokenValidationParameters = new TokenValidationParameters
                {
                    ValidateIssuer = true,
                    ValidateAudience = true,
                    ValidateLifetime = true,
                    ValidateIssuerSigningKey = true,
                    ValidIssuer = builder.Configuration[&quot;Jwt:Issuer&quot;],
                    ValidAudience = builder.Configuration[&quot;Jwt:Issuer&quot;],
                    IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtKey)),
                    ClockSkew = TimeSpan.Zero
                };
            });
        }

        // Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
        builder.Services.AddEndpointsApiExplorer();
        builder.Services.AddSwaggerGen(c =&gt;
        {
            c.SwaggerDoc(&quot;v1&quot;, new OpenApiInfo { Title = &quot;My API&quot;, Version = &quot;v1&quot; });

            // Define the BearerAuth scheme
            c.AddSecurityDefinition(&quot;BearerAuth&quot;, new OpenApiSecurityScheme
            {
                Type = SecuritySchemeType.Http,
                Scheme = &quot;bearer&quot;,
                BearerFormat = &quot;JWT&quot;,
                Description = &quot;Input your Bearer token only to access this API&quot;,
            });
            // Apply the BearerAuth scheme globally to all API operations
            c.AddSecurityRequirement(new OpenApiSecurityRequirement
                    {
                {
                    new OpenApiSecurityScheme
                    {
                        Reference = new OpenApiReference
                        {
                            Type = ReferenceType.SecurityScheme,
                            Id = &quot;BearerAuth&quot;
                        }
                    },
                    Array.Empty&lt;string&gt;()
                }
                    });
        });

        var app = builder.Build();

        // Configure the HTTP request pipeline.
        if (app.Environment.IsDevelopment())
        {
            app.UseSwagger();
            app.UseSwaggerUI(c =&gt;
            {
                c.SwaggerEndpoint(&quot;/swagger/v1/swagger.json&quot;, &quot;My API V1&quot;);
            });
        }

        app.UseSerilogRequestLogging();

        app.UseAuthentication();
        app.UseAuthorization();

        app.MapControllers();
        app.UseHttpsRedirection();

        using (var scope = app.Services.CreateScope())
        {
            var roleManager = scope.ServiceProvider.GetRequiredService&lt;RoleManager&lt;IdentityRole&lt;string&gt;&gt;&gt;();
            var roles = new[] { &quot;Admin&quot;, &quot;Customer&quot; };
            foreach (var role in roles)
            {
                if (!await roleManager.RoleExistsAsync(role))
                    await roleManager.CreateAsync(new IdentityRole(role));
            }
        }

        app.Run();
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,5,20,6,0],[21,9,21,58,0],[24,9,26,40,0],[26,40,26,115,0],[26,115,26,117,0],[28,9,30,55,0],[32,9,32,61,0],[32,61,32,120,0],[32,120,32,122,0],[34,9,34,55,0],[35,9,35,28,0],[36,9,36,10,0],[37,13,38,13,0],[38,13,38,14,0],[38,14,39,17,0],[39,17,39,92,0],[39,92,40,17,0],[40,17,40,89,0],[40,89,41,13,0],[41,13,41,14,0],[41,14,43,13,0],[43,13,43,14,0],[43,14,44,17,0],[44,17,54,19,0],[54,19,55,13,0],[55,13,55,14,0],[55,14,55,16,0],[56,9,56,10,0],[59,9,59,52,0],[60,9,61,9,0],[61,9,61,10,0],[61,10,62,13,0],[62,13,62,86,0],[62,86,65,13,0],[65,13,71,16,0],[71,16,73,13,0],[73,13,86,24,0],[86,24,87,9,0],[87,9,87,10,0],[87,10,87,12,0],[89,9,89,35,0],[92,9,92,45,0],[93,9,93,10,0],[94,13,94,30,0],[95,13,96,13,0],[96,13,96,14,0],[96,14,97,17,0],[97,17,97,76,0],[97,76,98,13,0],[98,13,98,14,0],[98,14,98,16,0],[99,9,99,10,0],[101,9,101,40,0],[103,9,103,33,0],[104,9,104,32,0],[106,9,106,30,0],[107,9,107,35,0],[109,16,109,54,0],[110,9,110,10,0],[111,13,111,109,0],[112,13,112,55,0],[113,13,113,20,0],[113,22,113,30,0],[113,31,113,33,0],[113,34,113,39,0],[114,13,114,14,0],[115,17,115,62,0],[116,21,116,75,0],[117,13,117,14,0],[118,9,118,10,0],[120,9,120,19,0],[121,5,121,6,0]]);
    </script>
  </body>
</html>