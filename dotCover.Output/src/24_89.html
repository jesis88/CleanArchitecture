<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\CleanArchitecture\Infrastructure\Services\RefreshTokenService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Application.EntityUser.Commands.CommandHandlers;
using Application.Interfaces;
using Domain.Entity;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;
using Newtonsoft.Json;
using System.Collections.Concurrent;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Security.Cryptography;
using System.Text;

namespace Infrastructure.Services
{
    public class RefreshTokenService : IRefreshTokenService
    {
        private readonly ConcurrentDictionary&lt;string, (string UserName, DateTime ExpiryDate)&gt; _refreshTokens = new();

        public void AddRefreshToken(string refreshToken, string userName, DateTime expiryDate)
        {
            _refreshTokens.TryAdd(refreshToken, (userName, expiryDate));
        }

        public (string UserName, DateTime ExpiryDate)? GetRefreshToken(string refreshToken)
        {
            if (_refreshTokens.TryGetValue(refreshToken, out var refreshTokenValue))
            {
                return refreshTokenValue;
            }
            return null;
        }

        public string GetUserName()
        {
            return _refreshTokens.First().Value.UserName;
        }

        public async Task&lt;string&gt; GetJWTAndRefreshToken(IUserManagerWrapper userManager, IConfiguration configuration, string userName, User user)
        {
            var jwtKey = configuration[&quot;Jwt:Key&quot;];
            if(jwtKey != null) 
            {
                var secretKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtKey));

                var signinCredentials = new SigningCredentials(secretKey, SecurityAlgorithms.HmacSha256);

                var roles = await userManager.GetRolesAsync(user);
                var claims = new List&lt;Claim&gt;();
                foreach (var role in roles)
                {
                    claims.Add(new Claim(ClaimTypes.Name, userName));
                    claims.Add(new Claim(ClaimTypes.Role, role));
                }
                var tokenOptions = new JwtSecurityToken(
                    issuer: configuration[&quot;Jwt:Issuer&quot;],
                    audience: configuration[&quot;Jwt:Issuer&quot;],
                    claims: claims,
                    expires: DateTime.Now.AddSeconds(60),
                    signingCredentials: signinCredentials
                );

                var jwtToken = new JwtSecurityTokenHandler().WriteToken(tokenOptions);

                var refreshToken = GenerateRefreshToken();
                var tokenData = new
                {
                    AccessToken = jwtToken,
                    RefreshToken = refreshToken.Token
                };

                AddRefreshToken(refreshToken.Token, userName, refreshToken.Expires);
                return JsonConvert.SerializeObject(tokenData);
            }
            else
            {
                throw new InvalidOperationException(&quot;Jwt key is null&quot;);
            }
        }

        private static RefreshToken GenerateRefreshToken()
        {
            return new RefreshToken()
            {
                Token = Convert.ToBase64String(RandomNumberGenerator.GetBytes(64)),
                Expires = DateTime.Now.AddMinutes(1)
            };
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,9,18,118,1],[21,9,21,10,1],[22,13,22,73,1],[23,9,23,10,1],[26,9,26,10,1],[27,13,27,85,1],[28,13,28,14,1],[29,17,29,42,1],[31,13,31,25,1],[32,9,32,10,1],[35,9,35,10,1],[36,13,36,58,1],[37,9,37,10,1],[40,9,40,10,0],[41,13,41,51,0],[42,13,42,31,0],[43,13,43,14,0],[44,17,44,90,0],[46,17,46,106,0],[48,17,48,67,0],[49,17,49,48,0],[50,17,50,24,0],[50,26,50,34,0],[50,35,50,37,0],[50,38,50,43,0],[51,17,51,18,0],[52,21,52,70,0],[53,21,53,66,0],[54,17,54,18,0],[55,17,61,19,0],[63,17,63,87,0],[65,17,65,59,0],[66,17,70,19,0],[72,17,72,85,0],[73,17,73,63,0],[76,13,76,14,0],[77,17,77,72,0],[79,9,79,10,0],[82,9,82,10,0],[83,13,87,15,0],[88,9,88,10,0]]);
    </script>
  </body>
</html>