<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>E:\CleanArchitecture\Infrastructure\DependencyInjection.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Application.Interfaces;
using AutoMapper;
using Hangfire;
using Hangfire.PostgreSql;
using Infrastructure.MappingProfiles;
using Infrastructure.Persistence;
using Infrastructure.Persistence.Repositories;
using Infrastructure.Services;
using Infrastructure.Wrappers;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Npgsql;

namespace Infrastructure
{
    public static class DependencyInjection
    {
        public static IServiceCollection AddInfrastructure(this IServiceCollection services, IConfiguration configuration)
        {
            services.AddDbContext&lt;CqrsDbContext&gt;(options =&gt;
             {
                 System.Diagnostics.Debug.WriteLine($&quot;PSQL_PASSWORD: {Environment.GetEnvironmentVariable(&quot;PSQL_PASSWORD&quot;)}&quot;);

                 var connectionStringBuilder = new NpgsqlConnectionStringBuilder(configuration.GetConnectionString(&quot;CleanArchitecture&quot;))
                 {
                     Password = Environment.GetEnvironmentVariable(&quot;PSQL_PASSWORD&quot;)
                 };
                 options.UseNpgsql(connectionStringBuilder.ConnectionString, b =&gt; b.MigrationsAssembly(&quot;Infrastructure&quot;));
                 options.EnableSensitiveDataLogging();
             });

            services.AddIdentity&lt;ApplicationUser, IdentityRole&lt;string&gt;&gt;()
                .AddRoles&lt;IdentityRole&lt;string&gt;&gt;()
                .AddEntityFrameworkStores&lt;CqrsDbContext&gt;()
                .AddDefaultTokenProviders();

            services.AddHangfire(x =&gt; x.UsePostgreSqlStorage(options =&gt;
            {
                var connectionStringBuilder = new NpgsqlConnectionStringBuilder(configuration.GetConnectionString(&quot;CleanArchitecture&quot;))
                {
                    Password = Environment.GetEnvironmentVariable(&quot;PSQL_PASSWORD&quot;)
                };
                options.UseNpgsqlConnection(connectionStringBuilder.ConnectionString);
            }));
            services.AddHangfireServer();

            services.AddScoped&lt;IUserManagerWrapper, UserManagerWrapper&gt;();
            services.AddScoped&lt;IRoleManagerWrapper, RoleManagerWrapper&gt;();
            services.AddScoped&lt;ICustomerWrapper, CustomerWrapper&gt;();
            services.AddScoped&lt;IEmailService, EmailService&gt;();

            var mappingConfig = new MapperConfiguration(mc =&gt;
            {
                mc.AddProfile(new ApplicationUserProfile());
                // Add other profiles if any
            });

            IMapper mapper = mappingConfig.CreateMapper();
            services.AddSingleton(mapper);
            services.AddSingleton&lt;IRefreshTokenService, RefreshTokenService&gt;();
            return services;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,0],[22,13,23,14,0],[23,14,23,15,0],[23,15,24,18,0],[24,18,24,126,0],[24,126,26,18,0],[26,18,29,20,0],[29,20,30,18,0],[30,18,30,83,0],[30,83,30,121,0],[30,121,30,123,0],[30,123,31,18,0],[31,18,31,55,0],[31,55,32,14,0],[32,14,32,15,0],[32,15,32,17,0],[34,13,37,45,0],[39,13,39,39,0],[39,39,40,13,0],[40,13,40,14,0],[40,14,41,17,0],[41,17,44,19,0],[44,19,45,17,0],[45,17,45,87,0],[45,87,46,13,0],[46,13,46,14,0],[46,14,46,15,0],[46,15,46,17,0],[47,13,47,42,0],[49,13,49,75,0],[50,13,50,75,0],[51,13,51,69,0],[52,13,52,63,0],[54,13,55,13,0],[55,13,55,14,0],[55,14,56,17,0],[56,17,56,61,0],[56,61,58,13,0],[58,13,58,14,0],[58,14,58,16,0],[60,13,60,59,0],[61,13,61,43,0],[62,13,62,80,0],[63,13,63,29,0],[64,9,64,10,0]]);
    </script>
  </body>
</html>